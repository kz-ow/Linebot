<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store">
  <title>詳細検索の設定</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LIFF SDK v2 -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* チェックボックスをスイッチ化 */
    .switch{--w:3rem;--h:1.6rem;position:relative;width:var(--w);height:var(--h);}
    .switch input{position:absolute;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden;}
    .switch .slider{position:absolute;inset:0;background:#cbd5e1;border-radius:9999px;transition:.2s;}
    .switch .slider::before{content:"";position:absolute;left:.2rem;bottom:.2rem;width:calc(var(--h) - .4rem);height:calc(var(--h) - .4rem);background:#fff;border-radius:9999px;transition:.2s;}
    .switch input:checked + .slider{background:#2563eb;}
    .switch input:checked + .slider::before{transform:translateX(calc(var(--w) - var(--h)));}
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-white rounded-xl shadow p-6">
    <h1 class="text-lg font-bold mb-5 text-center">詳細検索の設定</h1>

    <!-- スイッチ -->
    <form id="detailForm" class="grid gap-3 select-none">
      <div class="flex items-center justify-between p-3 rounded-lg border">
        <span class="mr-4">詳細検索</span>
        <label class="switch" for="detailToggle">
          <input id="detailToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
    </form>

    <!-- type="button" でフォーム submit を回避 -->
    <button id="sendButton"
            type="button"
            class="mt-6 w-full py-2 rounded-md text-white bg-blue-600 transition-colors">
      送　信
    </button>

    <!-- 成功メッセージ -->
    <p id="statusMsg" class="mt-4 text-center text-green-600 font-semibold hidden">完了しました</p>
  </div>

  <script type="module">
    /* ======== 環境設定 ======== */
    const LIFF_ID       = '2007363432-VoWb7qW0';   // ビルド時に置換
    const POST_ENDPOINT = '/app/register/detail/'; // 相対 or 絶対 URL
    /* ========================= */

    document.addEventListener('DOMContentLoaded', async () => {
      const insideLiff = typeof window.liff !== 'undefined';
      let idToken = null;

      /* LIFF 初期化を試みるが、失敗しても続行 */
      if (insideLiff) {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          idToken = liff.getIDToken();
        } catch (e) {
          console.warn('LIFF 初期化に失敗:', e);
        }
      }

      /* DOM 取得 */
      const toggle    = document.getElementById('detailToggle');
      const sendBtn   = document.getElementById('sendButton');
      const statusMsg = document.getElementById('statusMsg');
      
      /* 送信処理 */
      sendBtn.addEventListener('click', async (event) => {
        event.preventDefault();                // フォーム submit を完全封じる
        const chosen = toggle.checked ? 'ON' : 'OFF';
        console.log('送信値:', chosen);

        const headers = { 'Content-Type': 'application/json' };
        if (idToken) headers['Authorization'] = `Bearer ${idToken}`;
      
        try {
          const res = await fetch(POST_ENDPOINT, {
            method : 'POST',
            headers: headers,
            body   : JSON.stringify({ scheduler: chosen })
          });

          if (!res.ok) throw new Error('server ' + res.status);
          console.log('POST success');

          /* 成功メッセージを表示 */
          statusMsg.textContent = '完了しました';
          statusMsg.classList.remove('hidden');

          if (insideLiff) {
            setTimeout(() => liff.closeWindow(), 1000); // 1 秒後に自動クローズ
          }
        } catch (err) {
          console.error('POST failed:', err);
          alert('送信に失敗しました');
        }
      });
    });
  </script>
</body>
</html>
